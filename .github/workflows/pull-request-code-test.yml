name: pull-request-code-test

on:
  pull_request:
    branches:
    - develop
  workflow_dispatch:

permissions:
  issues: write # [ì¶”ê°€] ì´ìŠˆ ìƒì„±ì„ ìœ„í•´ ì“°ê¸° ê¶Œí•œ í•„ìš”

jobs:
  code-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PYTHON
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          echo "ì˜ì¡´ì„± íŒŒì¼, í…ŒìŠ¤íŠ¸ ë„êµ¬ ì„¤ì¹˜ì¤‘..."
          python -m pip install --upgrade pip
          pip install flake8 pytest isort
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run isort (Check import order)
        run: |
          echo "isort test start...."
          isort . --check-only --diff

      - name: Run flake8 (Linting)
        run: |
          echo "flake8 test start...."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run pytest
        run:  |
          echo "pytest test start...."
          pytest
      

      # [ì¶”ê°€] í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìƒì„± (if: failure() ì‚¬ìš©)
      - name: Create Issue on Failure
        if: failure() # ì•ì„  ë‹¨ê³„ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ì‹¤í–‰ë¨
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ERROR:   failed test"
          TITLE="ğŸš¨ Code Test Failed: $GITHUB_WORKFLOW"
          BODY="Code test failed in run [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}). Please check the logs."
          gh issue create --title "$TITLE" --body "$BODY"
      - name: Code Test End Up
        run: echo "code test end up successfully!"
